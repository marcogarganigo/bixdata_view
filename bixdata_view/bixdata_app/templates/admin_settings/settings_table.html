<style>
    .table-button {
        width: 20%;
        text-align: left;
        margin-bottom: 5px;
    }

    .fields-button {
        width: 100%;
        margin-bottom: 5px;
    }
</style>

<script>

    function hideSettings() {
        var els = document.querySelectorAll('.visible');
        els.forEach(function (el) {
            el.classList.remove('visible');
            el.html('');
            //el.classList.add('hidden');
        });
    }


    function getUserTablesList(userid)
    {
        $("#settings_table_usertables").load('/loading/')
        //pick all the elements with the class visible and css background the

        var serialized_data = [];
        serialized_data.push({ name: 'userid', value: userid });
        $.ajax({
            type: "POST",
            crossDomain: true,
            url: "{% url 'settings_table_usertables' %}",
            data: serialized_data,
            success: function (response) {
                $("#settings_table_usertables").html(response);
            },
            error: function () {
                $("#settings_table_usertables").html(response);
            }
        });
    }

function saveTableSettings(el) {

    updateOrder();

    var serialized_data = []
    var userid = $('#user_username').attr('data-userid');
    var orderArray = [];

    $('.drag-item').each(function () {

            var workspace = $(this).attr('data-workspace');


            var tables = [];


            $(this).find('.drag-item2').each(function () {
                if ($(this).find('.checkbox').is(':checked')) {
                    var tableid = $(this).attr('data-tableid');
                    tables.push(tableid);
                }
            });
        orderArray.push({workspace: workspace, tables: tables});
    });

    orderArray = JSON.stringify(orderArray);
    console.info(orderArray)
    serialized_data.push({ name: 'tables', value: orderArray });
    $.ajax({
        type: "POST",
        url: "{% url 'settings_table_usertables_save' %}",
        data: {
            'tables': orderArray,
            'userid': userid
        },
        success: function (response) {
            swal({
                title: "Impostazioni salvate",
                text: "Le impostazioni sono state salvate correttamente",
                icon: "success",
                timer: 800,
                buttons: false,
            })
            $("#table_options").html(response);
        },
        error: function () {
        }
    });
}

function setFieldsOrder(fields_type) {


    var tableid = $('#table_settings_menu').attr('data-tableid');
    var userid = $('#user_username').attr('data-userid');

    $('#user_username').attr('data-fields_type', fields_type);



    $.ajax({
        type: "POST",
        url: "{% url 'settings_table_tablefields' %}",
        data: {tableid: tableid, userid: userid, fields_type: fields_type},
        success: function (response) {
            $("#settings_col4").css('display', 'block');

            $("#results-column-container").load('/loading/')

            setTimeout(function () {
                $("#results-column-container").html(response);
            }, 150);

        },
        error: function () {
        }
    });
}

function setFieldsOrderSave() {
    updateOrder()
    var orderArray = []

    var userid = $('#user_username').attr('data-userid');
    var tableid = $('#table_settings_menu').attr('data-tableid');
    var fields_type = $('#user_username').attr('data-fields_type');

    $('#settings_block_usertables_settings').find('.drag-item2').each(function () {
        if ($(this).find('.checkbox').is(':checked')) {
            var fieldid = $(this).find('.settings_block_usertables_fieldid').attr('data-fieldid');
            orderArray.push(fieldid);
        }
    });

    orderArray = JSON.stringify(orderArray);
    console.info(orderArray)

    $.ajax({
        type: "POST",
        url: "{% url 'settings_table_tablefields_save' %}",
        data: {
          'orderArray': orderArray,
          'userid': userid,
          'tableid': tableid,
          'fields_type': fields_type,
        },
        success: function (response) {
            swal({
                title: "Impostazioni salvate",
                text: "Le impostazioni sono state salvate correttamente",
                icon: "success",
                timer: 800,
                buttons: false,
            })
        },
        error: function () {
        }
    });
}

    function setColorTableButton(el) {
            var els = document.querySelectorAll('.table-button');
        els.forEach(function (el) {
            el.style.backgroundColor = '#6c757d';
        });
        el.style.backgroundColor = '#3b3c3e';

    }

    var els = document.querySelectorAll('.table-button');
    els.forEach(function (el) {
        el.addEventListener('click', function () {
            setColorTableButton(el);
        });
    });


    function tableSettingsSettings() {
        $.ajax({
            type: "POST",
            url: "{% url 'settings_table_tablesettings' %}",
            success: function (response) {
                alert('ok')
            },
            error: function () {
            }
        });
    }

    function fieldsSettingsSettings() {

        var tableid = $('#table_settings_menu').attr('data-tableid');
        var userid = $('#user_username').attr('data-userid');

        $.ajax({
            type: "POST",
            url: "{% url 'settings_table_fieldssettings' %}",
            data: {
                'tableid': tableid,
                'userid': userid,},
            success: function (response) {
                $('#table_settings_menu_options').html(response)
            },
        })
    }


    function tableColumnLinked() {

        var userid = $('#user_username').attr('data-userid');
        var tableid = $('#table_settings_menu').attr('data-tableid');


        $.ajax({
            type: "POST",
            data: {
                'userid': userid,
                'tableid': tableid,
            },
            url: "{% url 'settings_table_columnlinked' %}",
            success: function (response) {
               $("#settings_col4").css('display', 'block');

               $("#results-column-container").load('/loading/')

            setTimeout(function () {
                $("#results-column-container").html(response);
            }, 150);

            },
            error: function (response) {
            }
        });
    }

    function tableColumnLinkedSave()
    {
        $.ajax({
            type: "POST",
            url: "{% url 'settings_table_columnlinked_save' %}",
            success: function (response) {
                alert('ok')
            },
            error: function () {
            }
        });
    }

</script>

<div id="settings_table" style="height: 100%;">
    <div id="settings_table_users" style="width: 20%;float: left;">
        Utenti <br/>
        {% for user in users %}
            <button class="btn btn-secondary table-button "onclick="getUserTablesList('{{ user.id }}'); $('#user_username').attr('data-userid', '{{ user.id }}')">{{ user.username }}</button>
            <br>
        {% endfor %}
        <input type="text" hidden="true" disabled id="user_username" value="">
    </div>
    <div id="settings_table_usertables" style="width: 20%;float: left; height: 100%">

    </div>

    <div id="table_settings_menu" style="height: 20%; float: left; display: none; margin-left: 5%; ">
        Campi
        <br>
        <button class="btn btn-secondary fields-button" onclick="tableSettingsSettings()">Impostazioni tabella</button><br/>
        <button class="btn btn-secondary fields-button" onclick="fieldsSettingsSettings()">Impostazioni campi</button><br/>
        <button class="btn btn-secondary fields-button" onclick="tableColumnLinked()">Colonne in tabelle collegate</button><br/>
        <button class="btn btn-secondary fields-button" onclick="setFieldsOrder('search_results_fields')">Campi risultati ricerca</button><br/>
        <button class="btn btn-secondary fields-button" onclick="setFieldsOrder('insert_fields')">Campi inserimento</button><br/>
        <button class="btn btn-secondary fields-button" onclick="setFieldsOrder('search_fields')">Campi ricerca</button>
        <button class="btn btn-secondary fields-button" onclick="setFieldsOrder('view_fields')">Campi visualizzazione</button>
        <button class="btn btn-secondary fields-button" onclick="setFieldsOrder('badge_fields')">Campi badge</button>
    </div>
    <div id="settings_col4" style="height: 100%; width: 20%;  float: left; display: none; margin-left: 10%">
        <div id="results-column-container"style="height: 100%">

        </div>
    </div>

    <div id="table_settings_menu_options" style="height: 100%; float:left">

    </div>
</div>




