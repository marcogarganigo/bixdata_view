<style>

    @media (min-height: 1200px) {
        #content_records_calendar {
            max-height: 95%;
            height: 95%
        }
    }

     @media (min-height: 1000px) and (max-height: 1200px) {
        #content_records_calendar {
            max-height: 90%;
            height: 90%
        }
    }

    @media (max-height: 1000px) {
        #content_records_calendar {
            max-height: 79%;
            height: 79%
        }
    }

    .fc-title {
        font-weight: bold;
    }

    .fc-view {
        margin-top: 10px;
    }




</style>

<script>
    function selectTypeOfDate(datetype) {
        $.ajax({
            type: "POST",
            url: "{% url 'block_records_calendar' %}",
            data: {
                'datetype': datetype,
                'viewid': $('#viewid').val(),
                'tableid': '{{ tableid }}',
            },
            success: function (response) {
                $('#calendar-section-container').html(response);
            },
            error: function (response) {
            }

        })
    }
</script>

<div id="calendar-section-container" style="width: 100%; height: 100%">
    <select id="select-date-type" class="form-select" aria-label="Default select example" onchange="selectTypeOfDate(this.value)" style="width: 10%">
        {% for field in select_fields %}
            <option {{ field.selected }} value="{{ field.fieldid }}">{{ field.description }}</option>
        {% endfor %}
    </select>

    <div id="content_records_calendar">
    <div id="calendar"></div>
    </div>

</div>

<script>
    var jsonEvents = [];

    {% for event in events %}

        {% if event.start is None and event.end is None %}
            allDay = true;

            start = "{{ event.date }}"
            end = "{{ event.date }}"

        {% else %}

            allDay = false;

            start = "{{ event.start }}"
            end = "{{ event.end }}"
            planneddate = "{{ event.date }}"

            alert('{{ event.start }}')
            console.info('{{ event.start }}')
            console.info(start, end, planneddate)



            startTimeParts = start.split(":");
            endTimeParts = end.split(":");


            startDate = new Date(planneddate);
            startDate.setHours(parseInt(startTimeParts[0], 10));
            startDate.setMinutes(parseInt(startTimeParts[1], 10));

            endDate = new Date(planneddate);
            endDate.setHours(parseInt(endTimeParts[0], 10));
            endDate.setMinutes(parseInt(endTimeParts[1], 10));

            //VERIFICARE
            formattedStartDate = startDate.toISOString().slice(0, 19)
            formattedEndDate = endDate.toISOString().slice(0, 19)

            start = formattedStartDate;
            end = formattedEndDate;



        {% endif %}


        jsonEvents.push({
            "title": "{{ event.description }}",
            "start": start,
            "end": end,
            "allDay": allDay,
            "recordid": "{{ event.recordid_ }}",
            //"calendarid": "{{ event.o365_idcalendar }}"
        });

    {% endfor %}




    var calendar = $('#calendar').fullCalendar({
        events: jsonEvents,
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        editable: true,
        height: 'parent',
        eventClick: function (event) {
            //open_record_calendar(event.recordid);
            open_record(window.content, '{{ tableid }}', event.recordid, 'edit', '');

        },
        eventDrop: function (event, delta, revertFunc) {
            console.info(event)
            updateRecordDate(event.recordid, event.start._d)

        },


        eventRender: function (event, element) {

            // Customize event rendering to display only the event title
            element.find('.fc-title').html(event.title);
        },


        eventResize: function(event) {
            if ($('#select-date-type').val() == 'planneddate') {


                enddate = event.end._i

                enddate = enddate.map(number => number.toString());
                if (enddate[3] == '0') {
                    enddate[3] = '00'
                }
                if (enddate[4] == '0') {
                    enddate[4] = '00'
                }
                date = enddate[3] + ':' + enddate[4]
                enddate = date.toString()
                console.info(event.recordid)
                updateEndDate(enddate, event.recordid)

            }
            else {
                alert('You can resize only the planned date')
            }

        }
    });

    function updateRecordDate(recordid, date) {
        datetype = $('#select-date-type').val();

        $.ajax({
            type: "POST",
            url: "{% url 'update_record_date' %}",
            data: {
                'recordid': recordid,
                'datetype': datetype,
                'tableid': '{{ tableid }}',
                'date': date,
            },
            success: function (response) {
            },
            error: function (response) {
            }

        })
    }

    function updateEndDate(enddate, recordid) {
        alert('ok')
        $.ajax({
            type: "POST",
            url: "{% url 'update_end_date' %}",
            data: {
                'enddate': enddate,
                'recordid': recordid,
            },
            success: function (response) {
            },
            error: function (response) {
            }

        })
    }

</script>













