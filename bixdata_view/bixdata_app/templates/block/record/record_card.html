<style>
    #card-menu .btn {
        float: right;
        margin-left: 5px;
    }
</style>

<script type="text/javascript">
    // Funzione per aprire il modal e richiedere informazioni dal backend
    function openGasolioModal() {
        // Mostra un indicatore di caricamento (opzionale)
        swal({
            title: "Caricamento dati...",
            text: "Attendere prego.",
            icon: "info",
            buttons: false,
            closeOnClickOutside: false,
            closeOnEsc: false,
        });

        // Richiedi informazioni aggiuntive dal backend
        $.ajax({
            type: "POST",
            url: "{% url 'get_stampa_gasolio_info' %}", // Sostituisci con l'URL corretto
            data: {
                'recordid': '{{ recordid }}',
                'tableid': '{{ tableid }}',
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                // Chiudi l'indicatore di caricamento
                swal.close();

                // Inserisci le informazioni nel modal
                var backendInfoHtml = `
                        <!-- Aggiungi altre informazioni qui -->
                `;
                $('#backendInfo').html(backendInfoHtml);

                // Pulisci eventuali valori precedenti nel form
                $('#gasolioForm')[0].reset();

                // Mostra il modal
                $('#gasolioModal').modal('show');
            },
            error: function(xhr, status, error) {
                swal({
                    title: "Errore",
                    text: "Impossibile caricare le informazioni. Riprova più tardi.",
                    icon: "error",
                    button: "Ok",
                });
            }
        });
    }

    // Gestisci l'invio del form dal modal
    $('#submitGasolioForm').on('click', function() {
        // Raccogli i dati dal form
        var checkLetture = $('#checkLetture').val();
        var meseLettura = $('#meseLettura').val();

     

        // Mostra un indicatore di invio (opzionale)
        swal({
            title: "Attendere prego",
            text: "Attendere prego.",
            icon: "info",
            buttons: false,
            closeOnClickOutside: false,
            closeOnEsc: false,
        });

        // Invia i dati al backend per la stampa gasolio
        $.ajax({
            type: "POST",
            url: "{% url 'stampa_gasolio' %}", // Sostituisci con l'URL corretto
            data: {
                'recordid': '{{ recordid }}',
                'tableid': '{{ tableid }}',
                'checkLetture': checkLetture,
                'meseLettura': meseLettura,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            xhrFields: {
                responseType: 'blob' // Per gestire il download del file
            },
            success: function(response, status, xhr) {
                // Chiudi l'indicatore di invio
                swal.close();

                // Gestisci il download del file
                const contentType = xhr.getResponseHeader('content-type');
                const blob = new Blob([response], {type: contentType});
                const blobUrl = window.URL.createObjectURL(blob);
                const contentDisposition = xhr.getResponseHeader('content-disposition');
                let filename = 'stampa_gasolio.pdf'; // Valore predefinito

                if (contentDisposition && contentDisposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(contentDisposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }

                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(blobUrl);
                document.body.removeChild(a);

                // Mostra una notifica di successo
                swal({
                    text: "File generato e scaricato correttamente.",
                    icon: "success",
                    timer: 2000,
                    buttons: false,
                });
            },
            error: function(xhr, status, error) {
                swal({
                    title: "Errore",
                    text: "Impossibile generare il file. Riprova più tardi.",
                    icon: "error",
                    button: "Ok",
                });
            }
        });
    });
</script>


<script type="text/javascript">
    $("#RecordCard").ready(function () {
        $('[data-bs-toggle="tooltip"]').tooltip()
    });


    function closeModal() {
        $("#recordModal").modal("hide");
    }

    //appena la card carica aprire collegati di default
    var recordtab_{{recordid}} = '{{recordtab}}';
    $('#block_record_card-{{ tableid }}-{{recordid}}').ready(function () {
        if (recordtab_{{recordid}} === 'Linked') {
            $('#linked-tab-{{ tableid }}-{{ recordid }}').click();
        } else {
            $('#fields-tab-{{ tableid }}-{{ recordid }}').click();
        }

        if ('{{ tableid }}' === 'contratto') {
            $('#linked-tab-{{ tableid }}-{{ recordid }}').click();
            $('#label-pianificazione_contrattuale-{{ recordid }}').click();
        }
    });




    function caricaRis(el) {
        $(el)
        var serialized_data = [];
        //$("#bixdata_recordcard_container").load('Loading.php');
        /*
         $.ajax({
             type: "POST",
             url: controller_url + 'ajax_get_recordcard',
             data: serialized_data,
             success: function(response) {
                 //$("#bixdata_recordcard_container").html(response);
                 $("#bixdata_recordcard_container").html('test');
             },
             error: function() {
                 $("#bixdata_recordcard_container").html(response);
             }
         });*/
    }

    if (screen.width <= min_width) {
        if ($("html").attr("data-sidenav-size") == "condensed") {
            $(".tabs-title").css("display", "none");
            $(".tabs-icon").css("display", "block");
        }
    } else {
        $(".tabs-title").css("display", "block");
        $(".tabs-icon").css("display", "none");
    }

    function copyFunc(el, tableid, recordid) {

        $(el).find('.mdi').removeClass('mdi-content-copy')
        $(el).find('.mdi').addClass('mdi-checkbox-multiple-marked-outline')

        setTimeout(function () {
            $(el).find('.mdi').removeClass('mdi-checkbox-multiple-marked-outline')
            $(el).find('.mdi').addClass('mdi-content-copy')
        }, 1500);

        var url = window.location.href;
        var urlParts = url.split('/');
        var baseUrl = urlParts[0] + '//' + urlParts[2] + '/';
        var link = baseUrl + 'get_record_path/' + tableid + '/' + recordid;

        $.ajax({
            type: "POST",
            url: "{% url 'record_card_copy' %}",
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                link: link
            },
        });
    }

    function duplicateFunc() {
        var serialized_data = [];
        $.ajax({
            type: "POST",
            url: "{% url 'record_card_duplicate' %}",
            data: serialized_data,
            success: function (response) {
                alert('duplicate')
            },
            error: function (response) {
                alert('duplicate')
            }
        });
    }


    function deleteFunc(el) {
        var block_record_card = $(el).closest('.block_record_card')
        var tableid = $(block_record_card).data('tableid')
        var recordid = $(block_record_card).data('recordid')
        var master_tableid = $(block_record_card).data('master_tableid')
        var master_recordid = $(block_record_card).data('master_recordid')
        swal({
            text: "Se sicuro di voler eliminare questo record?",
            buttons: ["No", "Si"],
            icon: "warning",
            dangerMode: true,
        }).then(function (value) {
            if (value) {
                $.ajax({
                    type: "POST",
                    url: "{% url 'record_card_delete' %}",
                    data: {
                        'tableid': tableid,
                        'recordid': recordid,
                    },
                    success: function (response) {
                        $(el).closest('.modal').modal("hide");
                        swal({
                            text: "Record eliminato",
                            icon: "success",
                            timer: 1000,
                            buttons: false,
                        });
                        if ((master_tableid == 'None')) {
                            refresh();
                        } else {
                            load_linked(tableid + '-' + master_recordid, tableid, master_recordid, master_tableid)
                            load_badge(master_tableid, master_recordid)
                        }

                    },
                    error: function () {
                        // Handle error if needed
                    }
                });
            } else {
            }
        });
    }

    function backdropHide() {
        if ($('.modal-backdrop').attr('style') === 'hide') {
            $('.modal-backdrop').fadeIn(500);
        } else {
            $('.modal-backdrop').fadeOut(500);
        }
    }

    function get_timesheet_serviceassets(el) {
        var serialized_data = [];
        $('#modalMedium').modal('show');
        $.ajax({
            type: "POST",
            url: "{% url 'get_timesheet_serviceassets' %}",
            data: serialized_data,
            success: function (response) {
                $("#modalMedium-body").html(response);
            },
            error: function () {
                alert('pin')
            }
        });
    }

    /*
        function stampa(tableid) {
            var serialized_data = [];
            var filename = tableid + new Date().getTime() + '.dockx';
            var url = '/stampa_' + tableid + '/';

            $.ajax({
                type: "POST",
                url: url,
                data: {
                    'recordid': '{{ recordid }}',
                'filename': filename,
            },
            xhrFields: {
                responseType: 'blob' // Set the response type to 'blob'
            },
            success: function (response, status, xhr) {
                // Check if the request was successful
                if (xhr.status === 200) {
                    // Create a URL for the response blob
                    const url = URL.createObjectURL(response);

                    // Open the URL in a new tab
                    window.open(url, '_blank');
                } else {
                    // Handle the error case
                    console.error('Request failed with status:', xhr.status);
                }
            },
            error: function (xhr, status, error) {
                // Handle the error case
                console.error('Error:', error);
            }
        });
    }
*/

    function stampa(tableid) {
        var filename = tableid + new Date().getTime() + '.pdf';
        var urll = '/stampa_' + tableid + '/';


        var url = window.location.href;
        var urlSplit = url.split('/');
        var firstpart = urlSplit[0] + '//' + urlSplit[2];
        var completeURL = firstpart + '/static/pdf/'

        swal({
            title: "Generazione file in corso",
            text: " ",
            icon: "info",
            buttons: false,
        })


        $.ajax({
            type: "POST",
            url: urll,
            data: {
                'recordid': '{{ recordid }}',
                'tableid': '{{ tableid }}',
                'filename': filename,
                'completeUrl': completeURL,
            },
            xhrFields: {
                responseType: 'blob'
            },
            success: function (response, status, xhr) {
                swal({
                    title: "File Generato!",
                    text: "Il file è stato generato e scaricato correttamente",
                    icon: "success",
                    timer: 800,
                    buttons: false,
                })
                const contentType = xhr.getResponseHeader('content-type');
                const blob = new Blob([response], {type: contentType});

                const blobUrl = window.URL.createObjectURL(blob);

                const contentDisposition = xhr.getResponseHeader('content-disposition');
                const filename = contentDisposition.split(';')[1].trim().split('=')[1];

                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);

                a.click();

                window.URL.revokeObjectURL(blobUrl);
                document.body.removeChild(a);
            },
            error: function (response) {
                swal({
                    title: "Errore nella generazione del file",
                    text: "sengnalalo ad un tecnico del software al più presto",
                    icon: "error",
                    button: "Ok",
                    dangerMode: true,
                });
            }
        });
    }


    function rinnova_contratto() {
        $('#close-button').click()
        swal({
            text: "Inserisci totale ore contrattuali",
            content: "input",
            button: {
                text: "Rinnova",
                closeModal: false,
            },
        }).then((response) => {
            // Validate numeric input
            var contract_hours = parseFloat(response);
            if (isNaN(contract_hours)) {
                swal({
                    text: "Inserisci un valore numerico per le ore contrattuali.",
                    icon: "error",
                });
                return;
            }

            swal({
                text: "Inserisci numero fattura",
                content: "input",
                button: {
                    text: "Rinnova",
                    closeModal: false,
                },
            }).then((response) => {
                // Validate numeric input
                var invoicenr = response;
                if (invoicenr === '') {
                    swal({
                        text: "Inserisci un numero fattura.",
                        icon: "error",
                    });
                    return; // Stop further execution
                }

                $.ajax({
                    type: "POST",
                    url: "{% url 'rinnova_contratto' %}",
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'contract_hours': contract_hours,
                        'invoicenr': invoicenr,
                        'recordid': '{{ recordid }}',
                    },
                    success: function (response) {
                        $('#block_record_card-{{ tableid }}-{{ recordid }}').slideToggle(200, function () {
                        });
                        refresh();
                        swal({
                            text: "Contratto rinnovato",
                            icon: "success",
                            timer: 1000,
                            buttons: false,
                        });
                    },
                    error: function (response) {
                        alert('Ko')
                    }
                });
            });
        });
    }


    function validate_timesheet() {
        $.ajax({
            type: "POST",
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'recordid': '{{ recordid }}'
            },
            url: "{% url 'validate_timesheet' %}",
            success: function (response) {
                $('#fields_container_' + '{{ tableid }}' + '_' + '{{ recordid }}').load('/loading/');
                open_record(window.content, '{{ tableid }}', '{{ recordid }}')
                swal({
                    text: "Timesheet validated",
                    icon: "success",
                    timer: 1000,
                    buttons: false,
                });
            },
            error: function (xhr, status, error) {
                alert('An error occurred while validating the timesheet.');
            }
        });
    }

    function decline_timesheet() {
        swal({
            title: "Rifiuto timesheet",
            content: {
                element: "textarea",
                attributes: {
                    id: "decline-note-textarea",
                    placeholder: "Motivazione del rifiuto del timesheet ed eventuali correzioni",
                    disabled: false
                }
            },
            icon: "warning",
            buttons: {
                cancel: {
                    text: "Cancella",
                    value: null,
                    visible: true,
                    closeModal: true,
                },
                confirm: {
                    text: "Salva",
                    value: true,
                    visible: true,
                    closeModal: true,
                }
            }
        })
        .then((value) => {
            if (value) {

                decline_reason = $('#decline-note-textarea').val()
                recordid = '{{ recordid }}'

                $.ajax({
                    type: "POST",
                    url: "{% url 'decline_timesheet' %}",
                    data: {
                        'recordid': recordid,
                        'decline_reason': decline_reason
                    },
                    success: function (response) {
                        $('#fields_container_' + '{{ tableid }}' + '_' + '{{ recordid }}').load('/loading/');
                        open_record(window.content, '{{ tableid }}', '{{ recordid }}')
                        swal({
                            text: "Timesheet rifiutato",
                            icon: "success",
                            timer: 1000,
                            buttons: false,
                        });
                    },
                    error: function (xhr, status, error) {
                        alert('Errore');
                    }
                });

            }
        });
    }

    function open_freshdesk() {
        var url = 'https://swissbix.freshdesk.com/a/tickets/' + '{{ freshdeskid }}';
        window.open(url, '_blank');
    }

    function open_bexio() {
        var url = 'https://office.bexio.com/index.php/kb_order/show/id/' + '{{ id_bexio }}';
        window.open(url, '_blank');
    }

    function openModalFromCard() {

        $('#block_record_card-{{ tableid }}-{{ recordid }}').remove()


        var serialized_data = [];
        serialized_data.push({name: 'tableid', value: '{{ tableid }}'});
        serialized_data.push({name: 'recordid', value: '{{ recordid }}'});
        serialized_data.push({name: 'contextfunction', value: 'edit'});

        $.ajax({
            type: "POST",
            url: "{% url 'block_record_card' %}",
            data: serialized_data,
            success: function (response) {
                $('#recordModal').modal('show');
                $("#record-modal-content").html(response);
            }
        });
    }

    function serializeForm(formElements) {
        var formData = [];
        //var formElements = document.getElementById("myForm").elements;
        for (var i = 0; i < formElements.length; i++) {
            var element = formElements[i];
            if (element.name) {
                if (element.type === "select-multiple") {
                    var selectedOptions = [];
                    for (var j = 0; j < element.options.length; j++) {
                        if (element.options[j].selected) {
                            selectedOptions.push(element.options[j].value);
                        }
                    }
                    formData.push({name: element.name, value: selectedOptions});
                } else if (element.type === "checkbox") {
                    if (element.checked) {
                        formData.push({name: element.name, value: element.value});
                    }
                } else {
                    formData.push({name: element.name, value: element.value});
                }
            }
        }
        return formData;
    }

    function stampaWord(el, format, func) {
        
        swal({
            title: "Generazione file in corso",
            text: " ",
            icon: "info",
            buttons: false,
        })
        
        var block_record_card = $(el).closest('.block_record_card')
        var tableid = $(block_record_card).data('tableid')
        var recordid = $(block_record_card).data('recordid')
        serialized_form = serializeForm($('.save-button').closest('#universal-container-timesheet').find('.fields_container').find("select,textarea,input"));
        //set the value of creator in serialized_form
        serialized_form['creator'] = '{{ userid}}';
        serialized_json = convertFormToJSON(serialized_form);
        var post_data = [];
        post_data.push({name: 'tableid', value: tableid});
        post_data.push({name: 'recordid', value: recordid});
        post_data.push({name: 'fields', value: serialized_json});

        function_name = "/" + func + "/"


        $.ajax({
            type: "POST",
            url: function_name,
            data: {
                recordid: recordid,
                tableid: tableid,
                format: format,
            },
            xhrFields: {
                responseType: 'blob'
            },
            success: function (response, status, xhr) {
                
                swal({
                    title: "File Generato!",
                    text: "Il file è stato generato e scaricato correttamente",
                    icon: "success",
                    timer: 800,
                    buttons: false,
                })
                
                const contentType = xhr.getResponseHeader('content-type');
                const blob = new Blob([response], {type: contentType});

                const blobUrl = window.URL.createObjectURL(blob);

                const contentDisposition = xhr.getResponseHeader('content-disposition');
                const filename = contentDisposition.split(';')[1].trim().split('=')[1];

                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);

                a.click();

                window.URL.revokeObjectURL(blobUrl);
                document.body.removeChild(a);
            },
            error: function (response) {
                swal({
                    title: "Errore nella generazione del file",
                    text: "sengnalalo ad un tecnico del software al più presto",
                    icon: "error",
                    button: "Ok",
                    dangerMode: true,
                });
            }
        });
    }
     

    function stampaProject(type) {
        if('{{master_recordid}}' != 'None'){
            var recordid = '{{master_recordid}}';
        }else{
            var recordid = '{{recordid}}';
        }
        $.ajax({
            type: "POST",
            url: "{% url 'stampa_project' %}",
             data: {
                 'recordid': recordid,
                 'type': type,
             },

            success: function (response, status, xhr) {
                //open response in blank page
                var win = window.open('', '_blank');
                win.document.write(response);

            },
            error: function (response) {
                swal({
                    title: "Errore nella generazione del file",
                    text: "sengnalalo ad un tecnico del software al più presto",
                    icon: "error",
                    button: "Ok",
                    dangerMode: true,
                });
            }
        });
    }

    function setReminderMessage() {

    }

    async function taskReminderAlert() {
        
        $('#alert-reminder-container').slideToggle(200)
        
      }
      </script>
      <div id="alert-reminder-container" style="display:none">
        <div class="text-center" style=" margin: auto">
            <div style='' class='form-floating'><textarea id='task-reminder-message' class='form-control' placeholder='Scrivi un messaggio per il sollecito' style='height: 100px'></textarea><label for='floatingTextarea2'>Messaggio sollecito</label></div>
            <br>
            <button style='' type='button' class='btn btn-primary' onclick="$('#alert-reminder-container').slideToggle(200)">Annulla</button>
            <button style='' type='button' class='btn btn-primary' onclick="taskReminder($('#task-reminder-message').val()); $('#alert-reminder-container').slideToggle(200);">Invia</button>
        </div>
      </div>
      <script>
      
      function taskReminder(reminderMessage) {
          $.ajax({
              type: "POST",
              url: "{% url 'task_reminder' %}",
               data: {
                   'recordid': '{{ recordid}}',
                   'reminderMessage': reminderMessage,
               },
      
              success: function (response, status, xhr) {
                  //open response in blank page
                  swal({
                      text: "Sollecito inviato",
                      icon: "success",
                      timer: 1000,
                      buttons: false,
                  });
              },
              error: function (response) {
                  swal({
                      title: "Errore nell'invio del sollecito",
                      text: "sengnalalo ad un tecnico del software al più presto",
                      icon: "error",
                      button: "Ok",
                      dangerMode: true,
                  });
              }
          });
      }


    function taskFunctions(func) {
        $.ajax({
            type: "POST",
            url: "{% url 'task_functions' %}",
            data: {
                'func': func,
                'recordid': '{{ recordid }}',
                'tableid': '{{ tableid }}',
            },
            success: function (response) {
                swal({
                    text: "Task aggiornato",
                    icon: "success",
                    timer: 1000,
                    buttons: false,
                });

                $('#block_record_card-{{ tableid }}-{{ recordid }}').load('/loading/');

                open_record(window.content, '{{ tableid }}', '{{ recordid }}')
            },

            error: function (xhr, status, error) {
            }
        });
    }

    function downloadAttachment() {
        $.ajax({
            type: "POST",
            url: "{% url 'download_attachment' %}",
            data: {
                'recordid': '{{ recordid }}',
            },
             xhrFields: {
            responseType: 'blob'
            },
            success: function (blob, status, xhr) {
                var url = window.URL.createObjectURL(blob);
    
                var a = document.createElement('a');
                a.href = url;
    
                var disposition = xhr.getResponseHeader('Content-Disposition');
                var filename = 'downloaded_file';
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    var matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
    
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();



                swal({
                    text: "Allegato scaricato",
                    icon: "success",
                    timer: 1000,
                    buttons: false,
                });


            },

            error: function (xhr, status, error) {

            }
        });
    }

    function stampaMilestone() {
        $.ajax({
            type: "POST",
            url: "{% url 'stampa_milestone' %}",
            data: {
                'recordid': '{{ recordid }}',
            },
            success: function (response, status, xhr) {
                //open response in blank page
                var win = window.open('', '_blank');
                win.document.write(response);
            },
            error: function (response) {
                swal({
                    title: "Errore nella generazione del file",
                    text: "sengnalalo ad un tecnico del software al più presto",
                    icon: "error",
                    button: "Ok",
                    dangerMode: true,
                });
            }
        });
    
    }

</script>

<div id="block_record_card-{{ tableid }}-{{ recordid }}" class="block_record_card" data-recordid="{{ recordid }}"
     data-tableid="{{ tableid }}" data-master_tableid="{{ master_tableid }}"
     data-master_recordid="{{ master_recordid }}" style="height: 100%;width: 100%;">
    <div id="RecordCard" class="card RecordCard" style=" height: 100%; overflow: hidden">
        <div class="card-body" style="max-height: 100%">

            <div id="card-menu">
                <button type="button" id="close-button" class="btn-close button-recordcard" data-bs-dismiss="modal"
                        aria-label="Close" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="chiudi"
                        onclick="closeCard(this)"></button>
                {{ tableid }}

                {% if userid == 11 or userid == 15 %}
                    <button onclick="$('#recordid-text').show()">recordid</button>
                    
                    <span style="display:none" id="recordid-text">{{ recordid }}</span>

                {% endif %}

                <button type="button" class="btn btn button-recordcard" data-bs-toggle="tooltip"
                        data-bs-placement="bottom" data-bs-title="elimina" style="color: red"
                        onclick="deleteFunc(this)"><i
                        class=" mdi mdi-delete-outline"></i></button>

                <button type="button" class="btn btn button-recordcard" data-bs-toggle="tooltip"
                        data-bs-placement="bottom" data-bs-title="copia collegamento"
                        onclick="copyFunc(this,'{{ tableid }}', '{{ recordid }}')"><i
                        class="mdi mdi-content-copy"></i></button>

                {% if layout_setting == 'rightcard' %}
                    <button type="button" id="open-popup-{{ recordid }}" class=" btn btn  button-recordcard"
                            onclick="openModalFromCard()">
                        <span class="material-symbols-outlined">
                            open_in_full
                        </span>
                    </button>
                {% endif %}

                <div class="dropdown" style="margin-top: -2.6%">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Stampe
                    </button>

                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#">Stampa scheda</a></li>
                        {% if tableid == 'timesheet' or tableid == 'servicecontract'  %}
                            <li><a class="dropdown-item"
                                   onclick="stampa('{{ tableid }}')">
                                {% if tableid == 'timesheet' %}
                                    Stampa rapportino
                                {% elif tableid == 'servicecontract' %}
                                    Stampa report monte ore
                                {% elif tableid == 'stabile' %}
                                    Stampa report gasolio stabile
                                {% elif tableid == 'bollettini' %}
                                    Stampa bollettino
                                {% endif %}
                            </a></li>
                        {% endif %}
                        {% if tableid == 'stabile'  %}
                            <a class="dropdown-item" href="#" onclick="openGasolioModal()">Stampa report gasolio stabile</a>
                        {% endif %}
                        {% if tableid == 'bollettini'  %}
                            <a class="dropdown-item" href="#" onclick="stampa('{{ tableid }}')">Stampa bollettino</a>
                        {% endif %}
                        {% if tableid == 'projectmilestone' %}
                            <li><a class="dropdown-item"
                                   onclick="stampaMilestone()">
                                    Stampa milestone
                            </a></li>
                        {% endif %}
                        {% if tableid == 'deal' %}
                            <li><a class="dropdown-item" onclick="stampaWord(this,'','print_word')">
                                Stampa template ICT
                            </a></li>
                            <li><a class="dropdown-item" onclick="stampaWord(this,'','print_word_2')">
                                Stampa template mobile
                            </a></li>
                            <li><a class="dropdown-item" onclick="stampaWord(this,'pdf','print_word')">
                                Stampa in pdf
                            </a></li>
                        {% endif %}
                        {% if tableid == 'project' %}
                             <li><a class="dropdown-item" onclick="stampaProject('customer')">
                                 Stampa  per cliente
                            </a></li>
                            <li><a class="dropdown-item" onclick="stampaProject('swissbix')">
                                 Stampa  per swissbix
                            </a></li>
                        {% endif %} 
                    </ul>
                </div>


                {% if tableid == 'timesheet' %}
                    <button type="button" class="btn btn-light button-recordcard" data-bs-toggle="tooltip"
                            data-bs-placement="bottom" data-bs-title="elimina"
                            onclick="signatureFunction()">Firma
                    </button>

                    <div class="modal fade" id="signatureModal" aria-labelledby="signatureModal" aria-hidden="true" data-recordid="{{ recordid }}">
                        <div class="modal-dialog modal-fullscreen">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">Firma Digitale</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div id="signatureModalContent" class="modal-body">

                                </div>
                            </div>
                        </div>
                    </div>


                    <script>
                        function signatureFunction() {
                            $.ajax({
                                type: "POST",
                                url: "{% url 'signature_function' %}",
                                success: function (response) {
                                    $('#signatureModalContent').html(response);
                                    $('#signatureModal').modal('show');
                                    createCanvas()
                                },
                                error: function (xhr, status, error) {
                                }
                            });
                        }
                    </script>
                {% endif %}


                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                        Funzioni
                    </button>
                    <ul class="dropdown-menu">
                        {% if tableid == 'timesheet' %}
                            <li><a class="dropdown-item" onclick="get_timesheet_serviceassets(this)">Servizi e
                                risorse</a></li>
                        {% elif tableid == 'servicecontract' %}
                            <li><a class="dropdown-item" onclick="rinnova_contratto()">Rinnova</a></li>
                        {% elif tableid == 'ticket' %}
                            <li><a class="dropdown-item" onclick="open_freshdesk()">Apri in Freshdesk</a></li>
                        {% elif tableid == 'salesorder' %}
                            <li><a class="dropdown-item" onclick="open_bexio()">Apri in Bexio</a></li>
                        {% elif tableid == 'timetracking' %}
                            <li><a class="dropdown-item" onclick="newTimesheet('{{ recordid }}')">Nuovo Timesheet</a></li>
                        {% elif tableid == 'task' %}
                            <li><a class="dropdown-item" onclick="taskFunctions('plannedtoday')">Pianifica per oggi</a></li>
                            <li><a class="dropdown-item" onclick="taskFunctions('plannedtomorrow')">Pianifica per domani</a></li>
                            <li><a class="dropdown-item" onclick="taskFunctions('weekpostpone')">Rimanda scadenza di una settimana</a></li>
                            <li><a class="dropdown-item" onclick="taskFunctions('monthpostpone')">Rimanda scadenza di un mese</a></li>
                            <li><a class="dropdown-item" onclick="taskReminderAlert()">Sollecita</a></li>


                        {% endif %}
                        <!--<li><a class="dropdown-item" onclick="duplicateFunc()">Duplica</a></li>-->
                    </ul>
                </div>
                {% if tableid == 'attachment' %}
                    <button class="btn btn-primary" onclick="downloadAttachment()">Scarica allegato</button>
                {% endif %} 

                {% if tableid == 'deal' %}

                    <input type="file" id="fileInput" style="display: none;"/>
                    {% if dealstatus != 'Vinta' and dealstatus != 'Persa' %}
                        <button type="button" class="btn btn-success button-recordcard" data-bs-title="stampa"
                                onclick="dealCloseWon(this)">
                            Chiuso vinto
                        </button>

                        <button type="button" class="btn btn-danger button-recordcard" data-bs-title="stampa"
                                onclick="dealCloseLost(this)">
                            Chiuso perso
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                Fase vendita
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" onclick="dealUpdateDealstage(this,'Appuntamento')">Appuntamento</a>
                                </li>
                                <li><a class="dropdown-item" onclick="dealUpdateDealstage(this,'Offerta da preparare')">Offerta
                                    da preparare</a></li>
                                <li><a class="dropdown-item" onclick="dealUpdateDealstage(this,'Offerta inviata')">Offerta
                                    inviata</a></li>
                                <li><a class="dropdown-item" onclick="dealUpdateDealstage(this,'Archiviato')">Offerta
                                    archiviata</a></li>
                            </ul>
                        </div>

                    {% endif %}

                    <script>

                        function dealCloseWon(el) {
                            var block_record_card = $(el).closest('.block_record_card')
                            var tableid = $(block_record_card).data('tableid')
                            var recordid = $(block_record_card).data('recordid')

                            swal({
                                text: "Se sicuro sicuro sicurissimo di volere chiudere vinta questa trattativa? Ricorda di impostare leasing e acconto correttamente nel caso",
                                buttons: ["No", "Si"],
                                icon: "warning",
                                dangerMode: true,
                            }).then(function (value) {
                                if (value) {
                                    $.ajax({
                                        type: "POST",
                                        url: "{% url 'deal_close_won' %}",
                                        data: {
                                            'tableid': tableid,
                                            'recordid': recordid,
                                        },
                                        success: function (response) {
                                            $(el).closest('.modal').modal("hide");
                                            swal({
                                                text: "Trattativa aggiornata",
                                                icon: "success",
                                                timer: 1000,
                                                buttons: false,
                                            });
                                            refresh();

                                        },
                                        error: function () {

                                        }
                                    });
                                } else {

                                }
                            });


                        }

                        function dealCloseLost(el) {
                            var block_record_card = $(el).closest('.block_record_card')
                            var tableid = $(block_record_card).data('tableid')
                            var recordid = $(block_record_card).data('recordid')

                            swal({
                                text: "Mannaggina che peccato. Dai sarà per la prossima volta. forza roccia. Confermi la chiusura?",
                                buttons: ["No", "Si"],
                                icon: "warning",
                                dangerMode: true,
                            }).then(function (value) {
                                if (value) {
                                    $.ajax({
                                        type: "POST",
                                        url: "{% url 'deal_close_lost' %}",
                                        data: {
                                            'tableid': tableid,
                                            'recordid': recordid,
                                        },
                                        success: function (response) {
                                            $(el).closest('.modal').modal("hide");
                                            swal({
                                                text: "Trattativa aggiornata",
                                                icon: "success",
                                                timer: 1000,
                                                buttons: false,
                                            });
                                            refresh();

                                        },
                                        error: function () {
                                            // Handle error if needed
                                        }
                                    });
                                } else {

                                }
                            });


                        }

                        function dealUpdateDealstage(el, dealstage) {
                            var block_record_card = $(el).closest('.block_record_card')
                            var tableid = $(block_record_card).data('tableid')
                            var recordid = $(block_record_card).data('recordid')
                            $.ajax({
                                type: "POST",
                                url: "{% url 'deal_update_dealstage' %}",
                                data: {
                                    'tableid': tableid,
                                    'recordid': recordid,
                                    'dealstage': dealstage
                                },
                                success: function (response) {
                                    $(el).closest('.modal').modal("hide");
                                    swal({
                                        text: "Trattativa aggiornata",
                                        icon: "success",
                                        timer: 1000,
                                        buttons: false,
                                    });
                                    refresh();

                                },
                                error: function () {
                                    // Handle error if needed
                                }
                            });


                        }

                        function selectFile() {
                            // Trigger click on the file input element
                            $("#fileInput").trigger('click');
                        }

                        // Event listener for file input change
                        $("#fileInput").on("change", function () {
                            var file = this.files[0]; // Get the selected file

                            if (file) {
                                var formData = new FormData(); // Create a FormData object
                                formData.append("file", file); // Append the file to the FormData object with the key "file"
                                formData.append("tableid", '{{ tableid }}'); // Add tableid and recordid to the FormData
                                formData.append("recordid", '{{ recordid }}');

                                // AJAX request to send the file to the backend
                                $.ajax({
                                    url: "{% url 'link_file' %}", // Replace with your backend endpoint
                                    type: "POST",
                                    data: formData,
                                    processData: false,
                                    contentType: false,
                                    success: function (response) {
                                        swal({
                                            title: "Allegato",
                                            text: "File allegato correttamente",
                                            icon: "success",
                                            timer: 800,
                                            buttons: false,
                                        });
                                    },
                                    error: function (xhr, status, error) {
                                        // Handle error response
                                        console.error("Error uploading file", error);
                                    }
                                });
                            }
                        });

                    </script>
                {% endif %}

                <script>


                    if ($('#block_record_card-{{ tableid }}-{{ recordid }}').closest('.modal').length == 0) {
                        $('#open-popup-{{ recordid }}').css('display', 'block');
                    } else {
                        $('#open-popup-{{ recordid }}').css('display', 'none');
                    }
                </script>

                {% if tableid == 'task' %}
                    <button style="display: none" id="close-task-button-{{ recordid }}" class="btn btn-success"
                            type="button"
                            onclick="$('#input-{{ recordid }}-completed').val('Si'); change_checkbox_view(); $('#save-button-{{ recordid }}').click()">
                        Chiudi task
                    </button>
                {% endif %}

                {% if tableid == 'salespush' %}
                    <button id="close-salespush-button-{{ recordid }}" class="btn btn-success" type="button" onclick="closeSalespush()" style="display: {{ display }}">
                        Chiudi push
                    </button>

                    <script>
                    function closeSalespush() {
                        $.ajax({
                            type: "POST",
                            url: "{% url 'close_salespush' %}",
                            data: {
                                'recordid': '{{ recordid }}'
                            },
                            success: function (response) {
                                //reload card
                                $('#block_record_card-{{ tableid }}-{{ recordid }}').load('/loading/');
                                open_record(window.content, '{{ tableid }}', '{{ recordid }}')


                            },
                            error: function (response) {
                                alert('error')
                            }
                        });
                    }
                    </script>
                {% endif %}

                {% if tableid == 'timesheet' %}
                    {% if userid == 3 or userid == 9 or userid == 11 or userid == 15 %}
                        <button onclick="validate_timesheet()"
                                type="button" id="validate-button" style="display: {{ display }}"
                                class="btn btn-outline-success">Valida
                        </button>
                        <button onclick="decline_timesheet()"
                                type="button" id="decline-button" style="display: {{ display }}"
                                class="btn btn-outline-danger">Rifiuta
                        </button>
                    {% endif %}
                {% endif %}

                <div style="clear:both;"></div>
            </div>


            <div id="badge-container-{{ tableid }}-{{ recordid }}" class="container"
                 style="overflow: hidden;">
                {{ block_record_badge }}
            </div>


            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active" id="fields-tab-{{ tableid }}-{{ recordid }}" data-bs-toggle="tab"
                            data-bs-target="#fields-tab-pane-{{ tableid }}-{{ recordid }}" type="button" role="tab"
                            aria-controls="fields-tab-pane-{{ tableid }}-{{ recordid }}"
                            aria-selected="true"
                            onclick="load_fields(this, '{{ tableid }}', '{{ recordid }}', '{{ master_tableid }}', '{{ master_recordid }}')">

                        <p class="tabs-title">Campi</p>
                        <span class="material-symbols-outlined tabs-icon" data-bs-toggle="tooltip"
                              data-bs-title="fields">
                            text_fields
                        </span>

                    </button>
                    <button class="nav-link" id="linked-tab-{{ tableid }}-{{ recordid }}" data-bs-toggle="tab"
                            data-bs-target="#linked-tab-pane-{{ tableid }}-{{ recordid }}"
                            type="button" role="tab" aria-controls="linked-tab-pane-{{ tableid }}-{{ recordid }}"
                            aria-selected="false">

                        <p class="tabs-title">Collegati</p>
                        <span class="material-symbols-outlined tabs-icon" data-bs-toggle="tooltip"
                              data-bs-title="linked">
                            link
                        </span>

                    </button>
                    <!--
                    <button class="nav-link" id="attachment-tab-{{ tableid }}-{{ recordid }}" data-bs-toggle="tab"
                            data-bs-target="#attachment-tab-pane-{{ tableid }}-{{ recordid }}" type="button" role="tab"
                            aria-controls="attachment-tab-pane-{{ tableid }}-{{ recordid }}" aria-selected="false">

                        <p class="tabs-title">Allegati</p>
                        <span class="material-symbols-outlined tabs-icon" data-bs-toggle="tooltip"
                              data-bs-title="attachment">
                            attachment
                        </span>
                    </button>
                    <button class="nav-link" id="statistics-tab-{{ tableid }}-{{ recordid }}" data-bs-toggle="tab"
                            data-bs-target="#statistics-tab-pane-{{ tableid }}-{{ recordid }}" type="button" role="tab"
                            aria-controls="statistics-tab-pane-{{ tableid }}-{{ recordid }}" aria-selected="false">

                        <p class="tabs-title">Analitica</p>
                        <span class="material-symbols-outlined tabs-icon" data-bs-toggle="tooltip"
                              data-bs-title="analytics">
                            analytics
                        </span>
                    </button>
                    <button class="nav-link" id="history-tab-{{ tableid }}-{{ recordid }}" data-bs-toggle="tab"
                            data-bs-target="#history-tab-pane-{{ tableid }}-{{ recordid }}"
                            type="button" role="tab" aria-controls="history-tab-pane-{{ tableid }}-{{ recordid }}"
                            aria-selected="false">

                        <p class="tabs-title">Storico</p>
                        <span class="material-symbols-outlined tabs-icon" data-bs-toggle="tooltip"
                              data-bs-title="history">
                            history
                        </span>
                    </button>
                    </button>
                    <button class="nav-link" id="workflow-tab-{{ tableid }}-{{ recordid }}" data-bs-toggle="tab"
                            data-bs-target="#workflow-tab-pane-{{ tableid }}-{{ recordid }}"
                            type="button" role="tab" aria-controls="workflowtab-pane-{{ tableid }}-{{ recordid }}"
                            aria-selected="false">

                        <p class="tabs-title">Flusso di lavoro</p>
                        <span class="material-symbols-outlined tabs-icon" data-bs-toggle="tooltip"
                              data-bs-title="workflow">
                            rebase
                        </span>
                    </button>
                    -->
                </div>
            </nav>

            <div class="tab-content" id="tableTabContent" style="height: 80%">
                <div class="tab-pane tab-pane-fields fade show active" id="fields-tab-pane-{{ tableid }}-{{ recordid }}"
                     role="tabpanel"
                     aria-labelledby="fields-tab" tabindex="0" style="height: 100%">
                    {{ block_record_fields }}
                </div>

                <div class="tab-pane fade" id="linked-tab-pane-{{ tableid }}-{{ recordid }}" role="tabpanel"
                     aria-labelledby="linked-tab"
                     tabindex="0" style="height: 100%; overflow:scroll">
                    {{ block_record_linked }}
                </div>

                <div class="tab-pane fade" id="attachment-tab-pane-{{ tableid }}-{{ recordid }}" role="tabpanel"
                     aria-labelledby="attachment-tab"
                     tabindex="0">...
                </div>
                <div class="tab-pane fade" id="statistics-tab-pane-{{ tableid }}-{{ recordid }}" role="tabpanel"
                     aria-labelledby="statistics-tab"
                     tabindex="0">...
                </div>
                <div class="tab-pane fade" id="history-tab-pane-{{ tableid }}-{{ recordid }}" role="tabpanel"
                     aria-labelledby="history-tab"
                     tabindex="0">...
                </div>
                <div class="tab-pane fade" id="workflow-tab-pane-{{ tableid }}-{{ recordid }}" role="tabpanel"
                     aria-labelledby="workflow-tab"
                     tabindex="0">...
                </div>

            </div>
        </div>
    </div>
</div>

<style>
    @media screen and (max-width: 1080px) {
        #tableTabContent {
            height: 88% !important;
        }
    }

    @media screen and (min-width: 1080px) and (max-width: 2000px) {
        #tableTabContent {
            height: 70% !important;
        }
    }
</style>

<!-- Modal per la Stampa Gasolio -->
<div class="modal fade" id="gasolioModal" tabindex="-1" aria-labelledby="gasolioModalLabel" aria-hidden="true" >
    <div class="modal-dialog" style="border: 3px solid black;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="gasolioModalLabel">Dati per la Stampa Gasolio</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Informazioni dal Backend -->
          <div id="backendInfo">
            <!-- I dati verranno inseriti qui tramite JavaScript -->
          </div>
          <!-- Form per Input Aggiuntivi -->
          <div id="formContainer">
            <form id="gasolioForm" >
                {% csrf_token %}
                <!-- Select Si/No -->
                <label for="checkLetture">Vuoi segnare le letture come inviate?</label>
                <select id="checkLetture" name="checkLetture" required>
                    <option value="si">Si</option>
                    <option value="no" selected>No</option>
                </select>
        
                <!-- Select Multipla Anno-Mese Precompilata -->
                <label for="meseLettura">Seleziona Anno-Mese:</label>
                <select id="meseLettura" name="meseLettura"  required>
                    <option value="2024-novembre">2024 Novembre</option>
                    <option value="2024-dicembre">2024 Dicembre</option>
                    <option value="2025-gennaio" selected>2025 Gennaio</option>
                    <option value="2025-febbraio">2025 Febbraio</option>
                </select>
        
            </form>
        </div>
        
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="submitGasolioForm">Stampa</button>
        </div>
      </div>
    </div>
  </div>
  