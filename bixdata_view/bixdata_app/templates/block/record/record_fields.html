 <!--JQuery UI-->
<script src="https://cdn.jsdelivr.net/npm/jquery-ui/dist/jquery-ui.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/jquery-ui/dist/themes/base/jquery-ui.min.css" rel="stylesheet">

<div class="container fields_container" id="fields_container_{{tableid}}_{{recordid}}">


<style>
    #saved-alert {
          position: unset;
          float: right;
          width: 20%;
          height: 5%;
          z-index: 9999;
        }
</style>

{% for record_fields, labels in record_fields_labels.items %}
{% for field_key,field in record_fields.items %}
  {% with fieldname=field.fieldid %}
  {% with fieldid='field-'|add:field.fieldid %}
      <div class="row">
          <div class="col-lg-2" style="text-align: left">
              <p>{{field.description }}</p>
          </div>
          <div class="col field">
              {% if field.fieldtypeid == 'Parola' %}
                  {% if field.lookuptableid  %}
                      {% for valuecode in field.valuecode %}

            <script>
            document.getElementById("hidden-input").value = "{{ items.code }}";
            document.getElementById("{{ fieldid }}").value = "{{ items.value }}";
            </script>
            <div class="input-group mb-2">
              <select id="{{ fieldid }}" name="{{ fieldname }}" class="form-select">
              {% if field.lookupitems %}
                <option value=""></option>
                    {% for item in field.lookupitems %}
                        {% if item.itemcode == field.valuecode.0.code %}
                            <option selected value="{{ item.itemcode }}">{{ item.itemdesc }}</option>
                            {% else %}
                        <option value="{{ item.itemcode }}">{{ item.itemdesc }}</option>
                        {% endif %}
                    {% endfor %}
              {% endif %}
              </select>
            </div>
            {% endfor %}
            {% else %}
               <label>
                    <input id="{{ fieldid }}" name="{{ fieldname }}" class="form-control mb-2" type="text" value="{{ field.value }}">
                </label>
            {% endif %}
        {% endif %}
            {% if field.fieldtypeid == 'Data' %}
                <label>
                    <input id="{{ fieldid }}" name="{{ fieldname }}" class="form-control mb-2" type="date" value="{{ field.valuecode.0.code }}">
                </label>
            {% endif %}
            {% if field.fieldtypeid == 'Seriale' %}
            <p>{{ field.value}}</p>
            {% endif %}
            {% if field.fieldtypeid == 'Numero' %}
                <label>
                    <input id="{{ fieldid }}" name="{{ fieldname }}" class="form-control mb-2" type="number" value="{{ field.value }}">
                </label>
            {% endif %}
            {% if field.fieldtypeid == 'Memo' %}
                <textarea class="form-control mb-2" id="{{ fieldid }}" name="{{ fieldname }}" rows="3">{{ field.value }}</textarea>
            {% endif %}
            {% if field.fieldtypeid == 'Ora' %}
                <label>
                    <input id="{{ fieldid }}" name="{{ fieldname }}" class="form-control mb-2" type="time" value="{{ field.value }}">
                </label>
            {% endif %}
            {% if field.fieldtypeid == 'Utente' %}
            <div class="input-group mb-2">
              <select id="{{ fieldid }}" name="{{ fieldname }}" class="form-select">
                <option id="" value=""></option>
                  {% for items in field.lookupitems %}
                    {% if items.id and items.firstname and items.lastname %}
                        {% if items.id == field.valuecode.0.code %}
                            <option selected id="{{ items.id }}" value="{{ items.id }}">{{ items.firstname }} {{ items.lastname }}</option>
                            {% else %}
                <option id="{{ items.id }}" value="{{ items.id }}">{{ items.firstname }} {{ items.lastname }}</option>
                            {% endif %}
                  {% endif %}
                  {% endfor %}
              </select>
            </div>
            {% endif %}
            {% if field.fieldtypeid == 'linkedmaster' %}
            <div class="ui-widget">
              <input class="form-select mb-2" id="{{ fieldid }}" style="width: 80%" value="{{ field.value }}" onfocus="selectAllText(this); showOptions()">
            </div>

                  <input type="hidden" class="hidden-input" name="{{ field.fieldid }}" value="{{ field.recordid }}">

                  <script>
                    $(function() {
                      function log( message ) {
                        $( "<div>" ).text( message ).prependTo( "#log" );
                        $( "#log" ).scrollTop( 0 );
                      }
                      $( "#{{ fieldid }}" ).autocomplete({
                        source: function(request, response) {
                          $.ajax({
                            url: "{% url 'get_autocomplete_data' %}",
                            data: {
                              'term': request.term,
                              'tableid': '{{tableid}}',
                              'mastertableid': '{{ field.tablelink }}'
                            },
                            success: function(data) {
                              console.info(data)
                              response(data.data);
                            }
                          });
                        },
                        minLength: 2,
                        select: function( event, ui ) {
                          //console.log( "Selected: " + ui.item.id );
                          $(this).closest('.field').find('.hidden-input').val(ui.item.id);
                          $.ajax({
                            url: "{% url 'get_badge' %}",
                            data: {
                              'recordid': ui.item.id,
                              'tableid': '{{tableid}}',
                            },
                            success: function(data) {
                              console.info(data)
                              response(data.data);
                            }
                          });
                        }
                      });
                    });


                    function showOptions() {
                      $( "#{{ fieldid }}" ).autocomplete({
                        source: function(request, response) {
                          $.ajax({
                            url: "{% url 'get_autocomplete_data' %}",
                            data: {
                              'term': request.term,
                              'tableid': '{{tableid}}',
                              'mastertableid': '{{ field.tablelink }}'
                            },
                            success: function(data) {
                              console.info(data)
                              response(data.data);
                            }
                          });
                        },
                        minLength: 0,
                        select: function( event, ui ) {
                          //console.log( "Selected: " + ui.item.id );
                          $(this).closest('.field').find('.hidden-input').val(ui.item.id);
                        }
                      });
                    }
                  </script>
              {% endif %}

          </div>
      </div>
          {% for items in field.valuecode %}
          {% if items.value and items.code %}
              <script>
              document.getElementById("hidden-input").value = "{{ items.code }}";
              document.getElementById("{{ fieldid }}").value = "{{ items.value }}";
              </script>
          {% endif %}
      {% endfor %}
      {% endwith %}
      {% endwith %}
{% endfor %}
    {{ record_fields }}
{% endfor %}
            <button id="save-button" type="button" class="btn btn-primary" onclick=" save_record(this)">Salva</button>
</div>
      <div class="alert alert-success" role="alert" id="saved-alert" style="display: none">
    Salvato
</div>

<!--save alert-->

{% if function == "view" %}
  <script>
    $(document).ready(function(){
      $("input").attr("disabled", true);
      $("select").attr("disabled", true);
      $("textarea").attr("disabled", true);
      document.getElementById("save-button").style.display = "none";
    });
  </script>
{% else %}
  <script>
    $(document).ready(function(){
      $("input").attr("disabled", false);
      $("select").attr("disabled", false);
      $("textarea").attr("disabled", false);
    });
  </script>
{% endif %}


<style>
input:disabled, select:disabled, textarea:disabled {
  opacity: 1;
  cursor: default;
  background-color: #fff !important;
  color: #000;
}
</style>

<script>
function save_record(el) {
    closeNewRecordModal()
    var serialized_array = $(el).closest('.fields_container').find("select,textarea,input").serializeArray();
    var serialized_json=convertFormToJSON(serialized_array);
    var post_data=[];
    post_data.push({name: 'tableid',value: '{{ tableid }}'});
    post_data.push({name: 'recordid',value: '{{ recordid }}'});
    post_data.push({name: 'fields',value: serialized_json});


    $.ajax({
        type: "POST",
        url: "{% url 'save_record_fields' %}",
        data: post_data,
        success: function(response) {
            setTimeout(function() {
              if('{{ tableid }}'=='ticketbixdata')
              {
                  alert('Grazie per la segnalazione, gentilissimo rompicoglioni. La tua segnalazione verr√† presa in considerazione al piu presto, nel duemilacredici');
              }
              $("#saved-alert").css("display", "block");
              $("#saved-alert").fadeOut(1500);
              //getContentRecords('{{ tableid }}')
              $("#linked-container-{{ tableid }}").load('/loading/')
              load_linked(this,'{{ tableid }}')

            });

        },
        error: function() {
            alert('ko')
        }
    });
}


function selectAllText(input) {
  input.setSelectionRange(0, input.value.length);
}


</script>

<style>
ul.ui-autocomplete{
  z-index: 11000;
}

</style>







