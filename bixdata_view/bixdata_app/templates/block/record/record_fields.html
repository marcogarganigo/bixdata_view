{% load define_action %}

<!--JQuery UI-->
<script src="https://cdn.jsdelivr.net/npm/jquery-ui/dist/jquery-ui.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/jquery-ui/dist/themes/base/jquery-ui.min.css" rel="stylesheet">


<div class="container fields_container" style="height: 100%" id="fields_container_{{ tableid }}_{{ recordid }}">


    <style>

        .select2-container--default .select2-selection--single {
            line-height: 28px;
            font-size: 15px;
            border: 1px solid #dee2e6 !important;
        }


        .select2-selection__rendered {
            color: #6c757d !important;
        }

        .select2-container {
            width: 50% !important;
        }

        .select2-selection__rendered {
            line-height: 37px !important;
        }

        .select2-container .select2-selection--single {
            height: 41px !important;
        }

        .select2-selection__arrow {
            height: 39px !important;
        }


        .select2-selection__choice {
            background-color: whitesmoke !important;
            color: black !important;
        }


        .select2-container--open {
            z-index: 9999999;
        }

        #saved-alert-{{ recordid }} {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 20%;
            min-width: 200px;
            max-width: 400px;
            height: auto;
            z-index: 9999;
        }


        ul.ui-autocomplete {
            z-index: 99999;
        }
    </style>

    <script>
        function toggleCollapse(el) {
            $(el).next('.div-collapse').slideToggle(200);
        }

        function serializeForm(formElements) {
            var formData = [];
            //var formElements = document.getElementById("myForm").elements;
            for (var i = 0; i < formElements.length; i++) {
                var element = formElements[i];
                if (element.name) {
                    if (element.type === "select-multiple") {
                        var selectedOptions = [];
                        for (var j = 0; j < element.options.length; j++) {
                            if (element.options[j].selected) {
                                selectedOptions.push(element.options[j].value);
                            }
                        }
                        formData.push({name: element.name, value: selectedOptions});
                    } else if (element.type === "checkbox") {
                        if (element.checked) {
                            formData.push({name: element.name, value: element.value});
                        }
                    } else {
                        formData.push({name: element.name, value: element.value});
                    }
                }
            }
            return formData;
        }


        function selectAllText(input) {
            input.setSelectionRange(0, input.value.length);
        }



        $('#fields_container_{{ tableid }}_{{ recordid }}').find('.js-example-basic-single').each(function () {
            $(this).select2({
                dropdownParent: $(this).parent()
            }).addClass('select2-initialized');
        });


        $(document).on('select2:open', function (e) {
            window.setTimeout(function () {
                document.querySelector('input.select2-search__field').focus();
            }, 0);
        })


        function set_checkbox_value(el) {
            if (el.checked) {
                $(el).next('input').val('Si');
            } else {
                $(el).next('input').val('No');
            }
        }

        $(document).ready(function () {

            // assuming the controls you want to attach the plugin to
            // have the "datepicker" class set
            $('input.datepicker').Zebra_DatePicker();

        });


    </script>


    {% for label,record_fields  in record_fields_labels.items %}
        {% if label != 'Dati' %}
            <button class="dropdown-toggle btn btn-secondary" style="width: 100%; background-color: #074048"
                    type="button" onclick="toggleCollapse(this)">
                {{ label }}
            </button>
        {% endif %}
        {% if label != 'Dati' %}

            <div class="div-collapse" style="display: none" id="collapse-{{ label }}">
            <div>
        {% else %}
            <div class="div-collapse" id="collapse-{{ label }}">
            <div>
        {% endif %}
    {% for field_key,field in record_fields.items %}
        {% if field.settings.obbligatorio == 'true' %}
            {% define 'necessary' as mandatory %}
            {% define 'badge bg-danger fs-5' as tooltip %}
        {% else %}
            {% define '' as mandatory %}
            {% define '' as tooltip %}
        {% endif %}



        {% with fieldname=field.fieldid %}
            {% with fieldid='field-'|add:field.fieldid %}
                <div class="row">
                    <div class="col-lg-2" style="text-align: left" title="{{ field.fieldid }}">
                        <p class="{{ tooltip }}">{{ field.description }}</p>
                    </div>
                    <div class="col field">
                        {% if field.fieldtypeid == 'Parola' %}
                            {% if field.fieldtypewebid == 'checkbox' %}
                                <input class="form-check-input mt-0" type="checkbox" value=""
                                       id="checkbox-{{ recordid }}"
                                       aria-label="Checkbox for following text input"
                                       onchange="set_checkbox_value(this)">
                                <input id="input-{{ recordid }}" type="hidden" name="{{ fieldname }}"
                                       value="{{ field.value }}">

                                <script>

                                    change_checkbox_view()

                                    function change_checkbox_view() {
                                        if ($('#input-{{ recordid }}').val() == 'Si') {
                                            $('#input-{{ recordid }}').prev('input').prop('checked', true);
                                        } else {
                                            $('#close-task-button-{{ recordid }}').css('display', 'block')
                                        }
                                    }

                                </script>

                            {% else %}
                                {% if field.lookuptableid %}
                                    {% for valuecode in field.valuecode %}
                                        <div class="input-group mb-2">
                                            {% if field.fieldtypewebid == 'multiselect' %}
                                                <select id="{{ fieldid }}" name="{{ fieldname }}"
                                                        class="js-example-basic-single {{ mandatory }}"
                                                        multiple="multiple">
                                            {% else %}
                                                <select id="{{ fieldid }}" name="{{ fieldname }}"
                                                        class="js-example-basic-single {{ mandatory }}">
                                            {% endif %}
                                            {% if field.lookupitems %}
                                                <option value=""></option>
                                                {% for item in field.lookupitems %}
                                                    {% if item.itemcode == field.valuecode.0.code %}
                                                        <option selected
                                                                value="{{ item.itemcode }}">{{ item.itemdesc }}</option>
                                                    {% else %}
                                                        <option value="{{ item.itemcode }}">{{ item.itemdesc }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            </select>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <label>
                                        <input id="{{ fieldid }}" name="{{ fieldname }}"
                                               class="form-control mb-2 {{ mandatory }}" type="text"
                                               value="{{ field.value }}">
                                    </label>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        {% if field.fieldtypeid == 'Data' %}
                            <label>
                            <label>
                                <input id="{{ fieldid }}" name="{{ fieldname }}"
                                       class="form-control mb-2 datepicker {{ mandatory }}" type="date"
                                       value="{{ field.valuecode.0.code }}">
                            </label>
                        {% endif %}
                        {% if field.fieldtypeid == 'Seriale' %}
                            <p>{{ field.value }}</p>
                        {% endif %}
                        {% if field.fieldtypeid == 'Numero' %}
                            <label>
                                <input id="{{ fieldid }}" name="{{ fieldname }}"
                                       class="form-control mb-2 {{ mandatory }}" type="number"
                                       value="{{ field.value }}">
                            </label>
                        {% endif %}
                        {% if field.fieldtypeid == 'Memo' %}
                            {% if fieldname == 'description' %}
                                <textarea style="min-height: 250px" class="form-control mb-2 {{ mandatory }}"
                                          id="{{ fieldid }}" name="{{ fieldname }}"
                                          rows="3">{{ field.value }}</textarea>
                            {% else %}
                                <textarea class="form-control mb-2 {{ mandatory }}" id="{{ fieldid }}"
                                          name="{{ fieldname }}" rows="3">{{ field.value }}</textarea>
                            {% endif %}
                        {% endif %}
                        {% if field.fieldtypeid == 'Ora' %}
                            <label>
                                <input id="{{ fieldid }}" name="{{ fieldname }}"
                                       class="form-control mb-2 {{ mandatory }}" type="time"
                                       value="{{ field.value }}">
                            </label>
                        {% endif %}
                        {% if field.fieldtypeid == 'Utente' %}
                            <div class="input-group mb-2">
                                <select id="{{ fieldid }}" name="{{ fieldname }}"
                                        class="js-example-basic-single {{ mandatory }}">
                                    <option id="" value=""></option>
                                    {% for items in field.lookupitems %}
                                        {% if items.id and items.firstname and items.lastname %}
                                            {% if items.id == field.valuecode.0.code %}
                                                <option selected id="{{ items.id }}"
                                                        value="{{ items.id }}">{{ items.firstname }} {{ items.lastname }}</option>
                                            {% else %}
                                                <option id="{{ items.id }}"
                                                        value="{{ items.id }}">{{ items.firstname }} {{ items.lastname }}</option>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        {% endif %}
                        {% if field.fieldtypeid == 'linkedmaster' %}
                            <div>
                                <input class="form-select mb-2 {{ mandatory }}"
                                       id="{{ fieldid }}-{{ recordid }}-autocomplete" style="width: 80%"
                                       value="{{ field.valuecode.0.value }}"
                                       onfocus="selectAllText(this); showOptions(this)">
                            </div>

                            <input type="hidden" class="hidden-input {{ mandatory }}" name="{{ field.fieldid }}"
                                   value="{{ field.recordid }}">
                        {% endif %}

                    </div>
                </div>
                {% for items in field.valuecode %}
                    {% if items.value and items.code %}
                    {% endif %}

                    <script>

                        $(function () {
                            function log(message) {
                                $("<div>").text(message).prependTo("#log");
                                $("#log").scrollTop(0);
                            }

                            $("#{{ fieldid }}-{{ recordid }}-autocomplete").autocomplete({
                                source: function (request, response) {
                                    $.ajax({
                                        url: "{% url 'get_autocomplete_data' %}",
                                        data: {
                                            'term': request.term,
                                            'tableid': '{{tableid}}',
                                            'mastertableid': '{{ field.tablelink }}'
                                        },
                                        success: function (data) {
                                            console.info(data)
                                            response(data.data);
                                        }
                                    });
                                },
                                minLength: 0, // Set minLength to 0 to show autocomplete on focus
                                select: function (event, ui) {
                                    // console.log( "Selected: " + ui.item.id );
                                    $(this).closest('.field').find('.hidden-input').val(ui.item.id);
                                    $.ajax({
                                        url: "{% url 'get_badge' %}",
                                        data: {
                                            'recordid': ui.item.id,
                                            'tableid': '{{tableid}}',
                                        },
                                        success: function (data) {
                                            console.info(data)
                                            response(data.data);
                                        }
                                    });
                                }
                            }).focus(function () {
                                // Trigger autocomplete on focus
                                $(this).autocomplete("search", "");
                            });

                            // Handle empty input
                            $("#{{ fieldid }}-{{ recordid }}").on("input", function () {
                                var inputValue = $(this).val();
                                if (inputValue === "") {
                                    $(this).val(""); // Imposta il valore predefinito
                                    $(this).closest('.field').find('.hidden-input').val("");

                                }
                            });
                        });


                        function showOptions() {
                            $(this).autocomplete({
                                source: function (request, response) {
                                    $.ajax({
                                        url: "{% url 'get_autocomplete_data' %}",
                                        data: {
                                            'term': request.term,
                                            'tableid': '{{tableid}}',
                                            'mastertableid': '{{ field.tablelink }}'
                                        },
                                        success: function (data) {
                                            console.info(data)
                                            response(data.data);
                                        }
                                    });
                                },
                                minLength: 0,
                                select: function (event, ui) {
                                    //console.log( "Selected: " + ui.item.id );
                                    $(this).closest('.field').find('.hidden-input').val(ui.item.id);

                                }
                            });
                        }
                    </script>

                {% endfor %}
            {% endwith %}
        {% endwith %}
    {% endfor %}

    </div>
    </div>
        <br></br>
    {% endfor %}

    </div>