 <!--JQuery UI-->
<script src="https://cdn.jsdelivr.net/npm/jquery-ui/dist/jquery-ui.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/jquery-ui/dist/themes/base/jquery-ui.min.css" rel="stylesheet">

<div class="container" id="fields_container">
{% for field_key,field in record_fields.items %}
  {% with fieldname=field.fieldid %}
  {% with fieldid='field-'|add:field.fieldid %}
      <div class="row">
          <div class="col-lg-2" style="text-align: left">
              <p>{{field.description }}</p>
          </div>
          <div class="col field">
              {% if field.fieldtypeid == 'Parola' %}
                  {% if field.lookuptableid  %}
                      {% for valuecode in field.valuecode %}

            <script>
            document.getElementById("hidden-input").value = "{{ items.code }}";
            document.getElementById("{{ fieldid }}").value = "{{ items.value }}";
            </script>
            <div class="input-group mb-2">
              <select id="{{ fieldid }}" name="{{ fieldname }}" class="form-select">
              {% if field.lookupitems %}
                  {% for item in field.lookupitems %}
                <option value="{{ item.itemcode }}">{{ item.itemdesc }}</option>
                    {% endfor %}
                  {% endif %}
              </select>
            </div>
            {% endfor %}
            {% else %}
               <label>
                    <input id="{{ fieldid }}" name="{{ fieldname }}" class="form-control mb-2" type="text" value="{{ field.value }}">
                </label>
            {% endif %}
        {% endif %}
            {% if field.fieldtypeid == 'Data' %}
                <label>
                    <input id="{{ fieldid }}" name="{{ fieldname }}" class="form-control mb-2" type="date" value="{{ field.value }}">
                </label>
            {% endif %}
            {% if field.fieldtypeid == 'Seriale' %}
            <p>{{ field.value}}</p>
            {% endif %}
            {% if field.fieldtypeid == 'Numero' %}
                <label>
                    <input id="{{ fieldid }}" name="{{ fieldname }}" class="form-control mb-2" type="number" value="{{ field.value }}">
                </label>
            {% endif %}
            {% if field.fieldtypeid == 'Memo' %}
                <textarea class="form-control mb-2" id="{{ fieldid }}" name="{{ fieldname }}" rows="3">{{ field.value }}</textarea>
            {% endif %}
            {% if field.fieldtypeid == 'Ora' %}
                <label>
                    <input id="{{ fieldid }}" name="{{ fieldname }}" class="form-control mb-2" type="time" value="{{ field.value }}">
                </label>
            {% endif %}
            {% if field.fieldtypeid == 'Utente' %}
            <div class="input-group mb-2">
              <select id="{{ fieldid }}" name="{{ fieldname }}" class="form-select">
                  {% for items in field.lookupitems %}
                    {% if items.id and items.firstname and items.lastname %}
                <option id="{{ items.id }}" value="{{ items.id }}">{{ items.firstname }} {{ items.lastname }}</option>
                  {% endif %}
                  {% endfor %}
              </select>
            </div>
            {% endif %}
            {% if field.fieldtypeid == 'linkedmaster' %}
            <div class="ui-widget">
              <input class="form-select mb-2" id="{{ fieldid }}" style="width: 80%" value="{{ field.value }}">
            </div>

                  <input type="hidden" class="hidden-input" name="{{ field.fieldid }}" value="{{ field.recordid }}">

                  <script>
                    $(function() {
                      function log( message ) {
                        $( "<div>" ).text( message ).prependTo( "#log" );
                        $( "#log" ).scrollTop( 0 );
                      }
                      $( "#{{ fieldid }}" ).autocomplete({
                        source: function(request, response) {
                          $.ajax({
                            url: "{% url 'get_autocomplete_data' %}",
                            data: {
                              'term': request.term,
                              'tableid': '{{tableid}}',
                              'mastertableid': '{{ field.tablelink }}'
                            },
                            success: function(data) {
                              console.info(data)
                              response(data.data);
                            }
                          });
                        },
                        minLength: 2,
                        select: function( event, ui ) {
                          //console.log( "Selected: " + ui.item.id );
                          $(this).closest('.field').find('.hidden-input').val(ui.item.id);
                        }
                      });
                    });
                  </script>
              {% endif %}

          </div>
      </div>
          {% for items in field.valuecode %}
          {% if items.value and items.code %}
              <script>
              document.getElementById("hidden-input").value = "{{ items.code }}";
              document.getElementById("{{ fieldid }}").value = "{{ items.value }}";
              </script>
          {% endif %}
      {% endfor %}
      {% endwith %}
      {% endwith %}
{% endfor %}
            <button id="save-button" type="button" class="btn btn-primary" onclick=" save_record()">Salva</button>
</div>

{% if function == "view" %}
  <script>
    $(document).ready(function(){
      $("input").attr("disabled", true);
      $("select").attr("disabled", true);
      $("textarea").attr("disabled", true);
      document.getElementById("save-button").style.display = "none";
    });
  </script>
{% else %}
  <script>
    $(document).ready(function(){
      $("input").attr("disabled", false);
      $("select").attr("disabled", false);
      $("textarea").attr("disabled", false);
    });
  </script>
{% endif %}


<style>
input:disabled, select:disabled, textarea:disabled {
  opacity: 1;
  cursor: default;
  background-color: #fff !important;
  color: #000;
}
</style>

<script>
function save_record() {
    closeNewRecordModal()
    var serialized_array = $('#fields_container').find("select,textarea,input").serializeArray();
    var serialized_json=convertFormToJSON(serialized_array);
    var post_data=[];
    post_data.push({name: 'tableid',value: '{{ tableid }}'});
    post_data.push({name: 'recordid',value: '{{ recordid }}'});
    post_data.push({name: 'fields',value: serialized_json});
    

    $.ajax({
        type: "POST",
        url: "{% url 'save_record_fields' %}",
        data: post_data,
        success: function(response) {
            setTimeout(function() {
                $("#saved-alert").fadeOut(1500);
                //getContentRecords('{{ tableid }}')
                $("#container-{{ tableid }}").load('/loading/')
                triggerCollapse($("#container-{{ tableid }}"), '{{ tableid }}', '{{ tableid }}')
            });

        },
        error: function() {
            alert('ko')
        }
    });
}


</script>

<style>
ul.ui-autocomplete{
  z-index: 11000;
}

</style>







